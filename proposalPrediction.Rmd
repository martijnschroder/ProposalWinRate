---
title: "Understanding proposal win rates"
author: "Martijn Schroder"
date: "1/05/2019"
output:
  html_document:
    df_print: paged
    toc: yes
  pdf_document:
    toc: yes
  html_notebook:
    fig_caption: yes
    toc: yes
---
```{r loading libraries and data, include=FALSE, cache=TRUE}
library(tidyverse)
library(dplyr)
library(lubridate)
library(ggthemes)
library(tibble)
library(caret)

# Read the dataset
# Change to de identified dataset: "data/data.csv"
proposals <- read_csv("data/data_real.csv", col_names = TRUE)

```


# Executive summary
In management consulting competitiveness is high. Our firm competes actively with the 'Big 4' consultancies. Better understanding of the reasons why we win and loose proposal will give us an advantage.

Our business makes decisions on our proposal management practice with the view to increase win rates. Until recently those decisions were made based on experience and perception of what works and what doesn't.

In this assignment my aim is to try machine learning approaches to gain insights into what the data tells us about the relevant features that are good predictors of win and lose rates.

Given the low number of transactions and limited cleanliness of the data, the analysis of features that should underpin decisions around proposals is relatively ambiguous. This is the main challenge to work with.

For obvious reasons the data is de identified.

# Cleaning data
The data set is a raw export from the system we use to manage opportunities. A csv export was obtained with the following structure:

```{r names and structure raw dataset, echo=TRUE}
summary(proposals) # show structure of data
```

The data needs cleaning up. The following changes are made:

* Rename the columns with names more suitable for analysis
* Convert "amount" column from chr to double
* Convert "creationDate" and "closeDate" to Date format

```{r renaming columns of dataset, include=FALSE, cache=TRUE}
# Rename columns to increase readibility and facilitate analysis
proposals <- proposals %>%
  rename(
    name = `Opportunity Name`,
    account = `Account Name`,
    stage = Stage,
    currency = `Amount Currency`,
    amount = Amount,
    practice = `Primary Practice`,
    offer = `Business Offer`,
    sector = Sector,
    director = `Proposal director`,
    manager = `Proposal manager`,
    source = Source,
    competitiveness = `Competitive or sole sourced (compulsory)`,
    amount = Amount,
    segment = Segment,
    creationDate = `Created Date`,
    closeDate = `Close Date`
  )

proposals$amount <- as.double(proposals$amount)
proposals$creationDate <- as.Date(proposals$creationDate, "%d/%m/%y")
proposals$closeDate <- as.Date(proposals$closeDate, "%d/%m/%y")

```


# Exploration
## Exploration of columns
Some basic exploration of the columns to better understand what information is useful, given business rules. There columns are **`r names(proposals)`**.

## Data integrity
The figure on the left hand side shows the proportion of NA values in the columns of the dataset. The following transformations have been applied to improve the dataset, resulting in the figure on the right hand side.

```{r NA values in dataset, include=FALSE}
# Step 1: create a tibble with column names and proportions of NA values per column
n <- nrow(proposals) # number of rows in dataset
sumNAbefore <- tibble(colSums(is.na(proposals)/n) # proportions of NA values per column
sumNAbefore <- cbind(colnames(proposals), sumNAbefore) # concatenate the vectors
names(sumNAbefore) <- c("feature", "proportion") # rename the columns to human readible

# plot NA proportions
sumNAbefore %>% ggplot(aes(reorder(feature, -proportion), proportion)) +
  geom_bar(stat = "Identity") +
  coord_flip() +
  xlab("Dataset column") +
  ylab("Proportion of NA values") +
  ggtitle("Proportion of NA values in the dataset columns") +
  theme_light()

```

The following approaches to addressing the NA values are proposed.

* Drop the column "Competitive or sole sourced (compulsory)". Although it would be interesting to see the impact of competitiveness on proposals, too many data points are missing to make it useful

* Amount: investigate if missing amounts can be replaced with amount group means for "account", "primary practice" and "business offer"

* Proposal director / manager: create "unknown" category for relevant observations. Doing this will retain observations for analysis and will not interfere with PCA

* Outline other wrangling to be conducted

```{r fix NA values in columns, include=FALSE}
# Step 2: transform the NA values
# 2a. drop the competitiveness column. It's too broken to be useful
proposals <- proposals %>% select(-competitiveness)

# 2b:  drop offer NA values as they only represent 2 observations
proposals <- proposals %>% filter(!is.na(offer)) # remove the offending observations

# 2c: replace amount values with average amounts for 
proposals[is.na(proposals$amount),]
nrow(proposals[is.na(proposals$amount),])
# 75 observations are returned. If other columsn don't feature too many NA values, we can substitute NAs
# with group means for account/stage/practice/offer/sector if possible
# TODO: fix amounts with group means through some method
# the following is a tempory fix - set the amount to the overall mean for amount

amounts <- as.double(proposals$amount[!is.na(proposals$amount)])
avg_amount <- mean(amounts[amounts > 999]) # calculate overall avg with values greater than 999
proposals$amount[is.na(proposals$amount)] <- avg_amount # replace NAs with avg amount
proposals$amount[proposals$amount <= 999] <- avg_amount # replace amounts < 999 with avg_amount
rm(amounts, avg_amount)

# Step 3. split name column into name and description. We don't need to reference number
proposals$account <-proposals$name %>% str_extract("^[A-Z]{3}") # 3 letter identifyer of opportunity
proposals$description <-sub("^[A-Z]{3}\\s\\d{4}\\s*[-]*\\s*", "", proposals$name) # name of opportunity
proposals <- proposals %>% select(-name) # name column now redundant. Can be dropped

```

## Data exploration
First some basic exploration of the data to get an understanding of what it tells us.

# Method

# Analysis

# Conclusions
